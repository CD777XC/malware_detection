# Importing libraries
import pickle
from sklearn.pipeline import make_pipeline
from sklearn.model_selection import train_test_split
from sklearn.metrics import precision_score
from sklearn.ensemble import RandomForestClassifier
import joblib

import os
import time

from preproc import preproc_pipe, X, y
from features_select import start

#################### Training model ####################

# Splitting the data set for training
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=.3, random_state=42)

# Instanciating model
model = RandomForestClassifier(max_depth=50, n_estimators=577)

# Instanciating final pipeline
pipe = make_pipeline(
    preproc_pipe,
    model
)

# Fitting the model
pipe.fit(X_train, y_train)

# Predicting
y_pred = pipe.predict(X_test)
precision = precision_score(y_true=y_test, y_pred=y_pred)

end = time.time()

print(f'Score: {pipe.score(X_test, y_test):.4f}')
print(f'Precision: {precision:.4f}')
print('---- %s seconds ----' %(round(end - start, 2)))

# Define the path to save the model
model_dir = 'models'
model_path = os.path.join(model_dir, 'malware_detection_v1.pkl')

# Check if the directory exists, if not, create it
if not os.path.exists(model_dir):
    os.makedirs(model_dir)
    print(f"Directory {model_dir} created")

# Save the model using joblib
joblib.dump(pipe, model_path)
print(f"Model saved to {model_path}")
